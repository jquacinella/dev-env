---
- name: Check if procs is installed
  tags: ["procs"]
  stat:
    path: /usr/local/bin/procs
  register: procs_stat

- name: Download and install procs
  tags: ["procs"]
  block:
    - name: Create temporary directory for procs
      tags: ["procs"]
      tempfile:
        state: directory
      register: procs_temp

    - name: Download procs zip
      tags: ["procs"]
      get_url:
        url: "https://github.com/dalance/procs/releases/download/{{ procs_version }}/procs-{{ procs_version }}-x86_64-linux.zip"
        dest: "{{ procs_temp.path }}/procs.zip"

    - name: Extract procs zip
      tags: ["procs"]
      unarchive:
        src: "{{ procs_temp.path }}/procs.zip"
        dest: "{{ procs_temp.path }}"
        remote_src: yes

    - name: Find procs binary in extracted directory
      tags: ["procs"]
      find:
        paths: "{{ procs_temp.path }}"
        patterns: "procs"
        recurse: yes
        file_type: file
      register: procs_binary

    - name: Install procs to /usr/local/bin
      tags: ["procs"]
      copy:
        src: "{{ procs_binary.files[0].path }}"
        dest: /usr/local/bin/procs
        mode: '0755'
        remote_src: yes

    - name: Clean up procs temporary directory
      tags: ["procs"]
      file:
        path: "{{ procs_temp.path }}"
        state: absent
  when: not procs_stat.stat.exists or (force_update | default(false) | bool)
