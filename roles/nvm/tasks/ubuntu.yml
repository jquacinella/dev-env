---
- name: Check if nvm is installed
  tags: ["nvm"]
  stat:
    path: "{{ user_home }}/.nvm/nvm.sh"
  register: nvm_stat
  become: no

- name: Download and install nvm
  tags: ["nvm"]
  block:
    - name: Download nvm install script
      tags: ["nvm"]
      get_url:
        url: "https://raw.githubusercontent.com/nvm-sh/nvm/{{ nvm_version }}/install.sh"
        dest: "/tmp/nvm_install.sh"
        mode: '0755'
      become: no

    - name: Run nvm install script
      tags: ["nvm"]
      shell: bash /tmp/nvm_install.sh
      args:
        creates: "{{ user_home }}/.nvm/nvm.sh"
      environment:
        HOME: "{{ user_home }}"
      become: no

    - name: Clean up nvm install script
      tags: ["nvm"]
      file:
        path: /tmp/nvm_install.sh
        state: absent
      become: no
  when: not nvm_stat.stat.exists
