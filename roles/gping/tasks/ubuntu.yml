---
- name: Check if gping is installed
  tags: ["gping"]
  stat:
    path: /usr/local/bin/gping
  register: gping_stat

- name: Download and install gping
  tags: ["gping"]
  block:
    - name: Create temporary directory for gping
      tags: ["gping"]
      tempfile:
        state: directory
      register: gping_temp

    - name: Download gping tarball
      tags: ["gping"]
      get_url:
        url: "https://github.com/orf/gping/releases/download/{{ gping_version }}/gping-Linux-gnu-x86_64.tar.gz"
        dest: "{{ gping_temp.path }}/gping.tar.gz"

    - name: Extract gping tarball
      tags: ["gping"]
      unarchive:
        src: "{{ gping_temp.path }}/gping.tar.gz"
        dest: "{{ gping_temp.path }}"
        remote_src: yes

    - name: Find gping binary in extracted directory
      tags: ["gping"]
      find:
        paths: "{{ gping_temp.path }}"
        patterns: "gping"
        recurse: yes
        file_type: file
      register: gping_binary

    - name: Install gping to /usr/local/bin
      tags: ["gping"]
      copy:
        src: "{{ gping_binary.files[0].path }}"
        dest: /usr/local/bin/gping
        mode: '0755'
        remote_src: yes

    - name: Clean up gping temporary directory
      tags: ["gping"]
      file:
        path: "{{ gping_temp.path }}"
        state: absent
  when: not gping_stat.stat.exists or (force_update | default(false) | bool)
